name: 'Code Review with Claude OAuth'

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]
  push:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      review_template:
        description: 'Review template to use'
        required: false
        default: 'combined'
        type: choice
        options:
          - quality
          - security
          - performance
          - typescript
          - combined
          - all

jobs:
  claude-code-review:
    name: 'Claude AI Code Review'
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pull-requests: write  # For commenting on PRs
      actions: read
    
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
        with:
          # Fetch full history for incremental reviews
          fetch-depth: 0
          
      - name: 'Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: 'Install Dependencies'
        run: |
          npm ci
          
      - name: 'Setup Code Review Agent'
        run: |
          # Install the code review agent globally or use local version
          npm install -g .
          # Or if running locally: make install
          
      - name: 'Configure Authentication'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}  # Optional fallback
        run: |
          echo "üîç Checking authentication..."
          
          # Verify OAuth token is available
          if [ -z "$CLAUDE_CODE_OAUTH_TOKEN" ]; then
            echo "‚ùå CLAUDE_CODE_OAUTH_TOKEN secret not configured"
            echo "Please add your Claude OAuth token to repository secrets"
            exit 1
          fi
          
          echo "‚úÖ Claude OAuth token configured"
          
          # Show config (without revealing secrets)
          code-review --config
          
      - name: 'Run Incremental Code Review'
        if: github.event_name == 'pull_request'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "üîç Running incremental code review for PR..."
          
          # Get the template from workflow input or use default
          TEMPLATE="${{ github.event.inputs.review_template || 'combined' }}"
          
          # Run incremental review (only changed files)
          code-review \
            --template "$TEMPLATE" \
            --incremental \
            --compare-with "origin/${{ github.base_ref }}" \
            --ci-mode \
            --output json \
            --output-file "review-results.json" \
            --auto-fallback \
            .
            
      - name: 'Run Full Code Review'
        if: github.event_name == 'push'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          echo "üîç Running full code review for push to ${{ github.ref_name }}..."
          
          # Get the template from workflow input or use default
          TEMPLATE="${{ github.event.inputs.review_template || 'security' }}"
          
          # Run full review with security focus for main branch
          code-review \
            --template "$TEMPLATE" \
            --ci-mode \
            --output json \
            --output-file "review-results.json" \
            --auto-fallback \
            .
            
      - name: 'Upload Review Results'
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: code-review-results
          path: review-results.json
          retention-days: 30
          
      - name: 'Comment on Pull Request'
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Read review results
            let reviewResults = [];
            try {
              const data = fs.readFileSync('review-results.json', 'utf8');
              reviewResults = JSON.parse(data);
            } catch (error) {
              console.log('No review results found or invalid JSON');
              return;
            }
            
            // Format results for PR comment
            const hasIssues = reviewResults.some(r => r.hasIssues);
            const totalFiles = reviewResults.length;
            const filesWithIssues = reviewResults.filter(r => r.hasIssues).length;
            
            let comment = `## ü§ñ Claude AI Code Review\n\n`;
            
            if (hasIssues) {
              comment += `**‚ö†Ô∏è Issues Found**: ${filesWithIssues}/${totalFiles} files have issues\n\n`;
            } else {
              comment += `**‚úÖ Clean Code**: No issues found in ${totalFiles} files\n\n`;
            }
            
            // Add detailed results
            if (hasIssues) {
              comment += `### üìã Detailed Results\n\n`;
              
              for (const result of reviewResults) {
                if (result.hasIssues) {
                  comment += `#### üìÑ \`${result.filePath}\`\n`;
                  comment += `${result.feedback}\n\n`;
                }
              }
            }
            
            // Add footer
            comment += `---\n`;
            comment += `*Review powered by Claude AI with OAuth token authentication*\n`;
            comment += `*Template: ${reviewResults[0]?.template || 'combined'}*`;
            
            // Post comment
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
            
      - name: 'Set Exit Code'
        if: always()
        run: |
          # Check if there were critical issues
          if [ -f "review-results.json" ]; then
            CRITICAL_ISSUES=$(jq '[.[] | select(.hasIssues and (.feedback | contains("Critical") or contains("üö®")))] | length' review-results.json)
            
            if [ "$CRITICAL_ISSUES" -gt 0 ]; then
              echo "‚ùå Found $CRITICAL_ISSUES critical issues - failing build"
              exit 1
            else
              echo "‚úÖ No critical issues found"
            fi
          fi

  # Optional: Security-focused review for sensitive files
  security-review:
    name: 'Security Review'
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'auth') || contains(github.event.pull_request.changed_files, 'security') || contains(github.event.pull_request.changed_files, '.env')
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: 'Checkout Repository'
        uses: actions/checkout@v4
        
      - name: 'Setup Node.js'
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: 'Install Dependencies'
        run: npm ci
          
      - name: 'Setup Code Review Agent'
        run: npm install -g .
          
      - name: 'Run Security Review'
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          echo "üîê Running security-focused review..."
          
          code-review \
            --template security \
            --incremental \
            --compare-with "origin/${{ github.base_ref }}" \
            --ci-mode \
            --output json \
            --output-file "security-results.json" \
            .
            
      - name: 'Upload Security Results'
        uses: actions/upload-artifact@v4
        with:
          name: security-review-results
          path: security-results.json
          retention-days: 30
